# Authentication

The v4 google sheets API requires some level of authentication to make any requests.<br>
_(v3 used to allow totally anonymous requests for read-only access to public sheets)_

You have several options for how you want to connect, but most projects should use a service account.

- [Service Account](#service-account) - connects as a specific "bot" user generated by google for your application
- [API-key](#api-key) - only identifies your application, provides read-only access
- [OAuth](#oauth) - connect on behalf of a specific user using OAuth

**ðŸ‘‰ BUT FIRST -- Set up your google project & enable the sheets API ðŸ‘ˆ**
1. Go to the [Google Developers Console](https://console.developers.google.com/)
2. Select your project or create a new one (and then select it)
3. Enable the Sheets API for your project
  - In the sidebar on the left, select **APIs & Services > Library**
  - Search for "sheets"
  - Click on "Google Sheets API"
  - click the blue "Enable" button

## ðŸ¤– Service Account (recommended) :id=service-account
**Connect as a bot user that belongs to your app**

This is a 2-legged oauth method and designed to be "an account that belongs to your application instead of to an individual end user".
Use this for an app that needs to access a set of documents that you have full access to, or can at least be shared with your service account.
([read more](https://developers.google.com/identity/protocols/OAuth2ServiceAccount))

You may also grant your service account ["domain-wide delegation"](https://developers.google.com/identity/protocols/oauth2/service-account#delegatingauthority) which enables it to impersonate any user within your org. This can be helpful if you need to connect on behalf of users _only within your organization_.

__Setup Instructions__

1. Follow steps above to set up project and enable sheets API
2. Create a service account for your project
  - In the sidebar on the left, select **APIs & Services > Credentials**
  - Click blue "+ CREATE CREDENTIALS" and select "Service account" option
  - Enter name, description, click "CREATE"
  - You can skip permissions, click "CONTINUE"
  - Click "+ CREATE KEY" button
  - Select the "JSON" key type option
  - Click "Create" button
  - your JSON key file is generated and downloaded to your machine (__it is the only copy!__)
  - click "DONE"
  - note your service account's email address (also available in the JSON key file)
3. Share the doc (or docs) with your service account using the email noted above

!> Be careful - never check your API keys / secrets into version control (git)

You can now use this file in your project to authenticate as your service account. If you have a config setup involving environment variables, you only need to worry about the `client_email` and `private_key` from the JSON file. For example:

```javascript
const creds = require('./config/myapp-1dd646d7c2af.json'); // the file saved above
const doc = new GoogleSpreadsheet('<YOUR-DOC-ID>');
await doc.useServiceAccountAuth(creds);

// or preferably, load that info from env vars / config instead of the file
await doc.useServiceAccountAuth({
  client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
  private_key: process.env.GOOGLE_PRIVATE_KEY,
});

// example using impersonation - NOTE: your service account must have "domain-wide delegation" enabled
// see https://developers.google.com/identity/protocols/oauth2/service-account#delegatingauthority
await doc.useServiceAccountAuth(creds, 'user.to.impersonate@mycompany.com');

```

**SPECIAL NOTE FOR HEROKU USERS (OR SIMILAR PLATFORMS)**

Sometimes setting/retreiving config vars that include line breaks can get tricky.

Here's one way to get it to work (using heroku cli):
1. Save the private key to a new text file
2. Replace `\n` with actual line breaks
3. Replace `\u003d` with `=`
4. run `heroku config:add GOOGLE_PRIVATE_KEY="$(cat yourfile.txt)"` in your terminal

And in some other scenarios something like this can be helpful:
```
await doc.useServiceAccountAuth({
  client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,
  private_key: process.env.GOOGLE_PRIVATE_KEY.replace(/\\n/g, "\n"),
});
```


## ðŸ”‘ API Key :id=api-key
**read-only access of public docs**

Google requires this so they can at least meter your usage of their API.

!> Allowing only read-only access using an API key is a limitation of Google's API (see [issuetracker](https://issuetracker.google.com/issues/36755576#comment3))

__Setup Instructions__
1. Follow steps above to set up project and enable sheets API
2. Create an API key for your project
  - Navigate to the [credentials section of the google developer console](https://console.cloud.google.com/apis/credentials)
  - Click blue "+ CREATE CREDENTIALS" and select "API key" option
  - Copy the API key
3. OPTIONAL - click "Restrict key" on popup to set up restrictions
  - Click "API restrictions" > Restrict Key"
  - Check the "Google Sheets API" checkbox
  - Click "Save"

!> Be careful - never check your API keys / secrets into version control (git)

```javascript
const doc = new GoogleSpreadsheet('<YOUR-DOC-ID>');
doc.useApiKey(process.env.GOOGLE_API_KEY);
```

## ðŸ‘¨â€ðŸ’» OAuth 2.0 :id=oauth
**connect on behalf of a user with an Oauth token**

Use [Google's OAuth2Client](https://github.com/googleapis/google-auth-library-nodejs#oauth2) to authenticate.

Handling Oauth and how it works is out of scope of this project - but the info you need can be found [here](https://developers.google.com/identity/protocols/oauth2).

Nevertheless, here is a rough outline of what to do with a few tips:
1. Follow steps above to set up project and enable sheets API
2. Create OAuth 2.0 credentials for your project (**these are not the same as the service account credentials described above**)
  - Navigate to the [credentials section of the google developer console](https://console.cloud.google.com/apis/credentials)
  - Click blue "+ CREATE CREDENTIALS" and select "Oauth Client ID" option
  - Select your application type and set up authorized domains / callback URIs
  - Record your client ID and secret
  - You will need to go through an Oauth Consent screen verification process to use these credentials for a production app with many users
3. For each user you want to connect on behalf of, you must get them to authorize your app which involves asking their permissions by redirecting them to a google-hosted URL
  - generate the oauth consent page url and redirect the user to it
    - there are many tools, [google provided](https://github.com/googleapis/google-api-nodejs-client#oauth2-client) and [more](https://www.npmjs.com/package/simple-oauth2) [generic](https://www.npmjs.com/package/hellojs) or you can even generate the URL yourself
    - make sure you use the credentials generated above
    - make sure you include the [appropriate scopes](https://developers.google.com/identity/protocols/oauth2/scopes#sheets) for your application
  - the callback URL (if successful) will include a short lived authorization code
  - you can then exchange this code for the user's oauth tokens which include:
    - an access token (that expires) which can be used to make API requests on behalf of the user, limited to the scopes requested and approved
    - a refresh token (that does not expire) which can be used to generate new access tokens
  - save these tokens somewhere secure like a database (ideally you should encrypt these before saving!)
4. Initialize an OAuth2Client with your apps oauth credentials and the user's tokens, and pass the client to your GoogleSpreadsheet object


```javascript
const { OAuth2Client } = require('google-auth-library');

// Initialize the OAuth2Client with your app's oauth credentials
const oauthClient = new OAuth2Client({
  clientId: process.env.GOOGLE_OAUTH_CLIENT_ID,
  clientSecret: process.env.GOOGLE_OAUTH_CLIENT_SECRET
});

// Pre-configure the client with credentials you have stored in e.g. your database
// NOTE - refresh_token is required, whilt the access token and expiryDate are optional
// (the refresh token is used to generate a missing/expired access token)
const { accessToken, refreshToken, expiryDate } = await fetchUserGoogleCredsFromDatabase();
oauthClient.credentials.access_token = accessToken;
oauthClient.credentials.refresh_token = refreshToken;
oauthClient.credentials.expiry_date = expiryDate; // Unix epoch milliseconds

// Listen in whenever a new access token is obtained. You might want to store them in your database.
// Mind that the refresh_token never changes (unless it's revoked, in which case your end-user will
// need to go through the full authentication flow again), so storing the new access_token is optional.
oauthClient.on('tokens', credentials => {
  console.log(credentials.access_token);
  console.log(credentials.scope);
  console.log(credentials.expiry_date);
  console.log(credentials.token_type); // will always be 'Bearer'
})

const doc = new GoogleSpreadsheet('<YOUR-DOC-ID>');
doc.useOAuth2Client(oauthClient);
```
